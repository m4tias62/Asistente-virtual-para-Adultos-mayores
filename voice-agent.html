<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<title>Asistente de Voz – Tarjeta Experta</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<style>
  html,body{margin:0;height:100%;background:#000;color:#000;}
</style>
<body>
<script>
(function(){
  const qs=location.hash.slice(1);
  const params=new URLSearchParams(qs);
  function b64ToUtf8(b64){
    try{
      const bin=atob(b64.replace(/-/g,'+').replace(/_/g,'/'));
      const bytes=Uint8Array.from(bin,c=>c.charCodeAt(0));
      return new TextDecoder().decode(bytes);
    }catch(e){return null;}
  }
  let expert=null;
  if(params.get('b64')){
    const txt=b64ToUtf8(params.get('b64'));
    try{expert=JSON.parse(txt);}catch(e){expert=null;}
  }
  if(!expert){
    expert={
      v:1,lang:"es-CL",
      kw:{ok:["listo","ok","ya","continuar"],rep:["repite","otra vez","no entendi","no entendí"],back:["atrás","volver"],help:["ayuda","no sé","no se"]},
      steps:[
        {id:"login",say:"Abramos tu app del banco. Cuando estés dentro, di: listo.",on:{ok:"menu",rep:"login"}},
        {id:"menu",say:"Busca Transferencias o Enviar dinero. Cuando lo encuentres, di: listo.",on:{ok:"origen",rep:"menu",back:"login"}},
        {id:"origen",say:"Si aparece, elige la cuenta de origen. Cuando la elijas, di: listo.",on:{ok:"dest",rep:"origen",back:"menu"}},
        {id:"dest",say:"¿Destinatario guardado? Si sí, selecciónalo y di listo. Si es nuevo, di: nuevo.",on:{ok:"monto",nuevo:"dest_new",rep:"dest"}},
        {id:"dest_new",say:"Ingresa nombre, RUT, banco, tipo y número de cuenta. Di: listo al terminar.",tip:"Si llega un código, cópialo y vuelve.",on:{ok:"monto",rep:"dest_new"}},
        {id:"monto",say:"Escribe el monto con cuidado. Cuando lo tengas, di: listo.",on:{ok:"rev",rep:"monto",back:"dest"}},
        {id:"rev",say:"Revisemos: destinatario y monto. Si está bien, di: listo. Si no, di: atrás.",on:{ok:"auth",back:"monto",rep:"rev"}},
        {id:"auth",say:"Autenticación: abre tu token o SMS y confirma. Di: listo al terminar.",on:{ok:"ok",rep:"auth",back:"rev"}},
        {id:"ok",say:"¡Listo! Transferencia enviada. Para repetir pasos, di: repetir. Para terminar, di: listo.",on:{rep:"menu",ok:"end"}},
        {id:"end",say:"Proceso finalizado. Bien hecho."}
      ]
    };
  }
  let stepIdxById={};expert.steps.forEach((s,i)=>{stepIdxById[s.id]=i;});
  let cur=0,started=false,speaking=false;
  function pickVoice(){
    const voices=speechSynthesis.getVoices()||[];
    const prefs=["es-CL","es-419","es-MX","es-ES","es"];
    for(const p of prefs){
      const v=voices.find(vv=>vv.lang&&vv.lang.toLowerCase().startsWith(p.toLowerCase()));
      if(v) return v;
    }
    return voices[0]||null;
  }
  function ensureVoices(cb){
    const have=speechSynthesis.getVoices();
    if(have&&have.length){cb();return;}
    speechSynthesis.onvoiceschanged=function(){cb();};
    setTimeout(cb,1000);
  }
  function speak(text,cb){
    if(!started) return;
    try{speechSynthesis.cancel();}catch(e){}
    speaking=true;
    const utt=new SpeechSynthesisUtterance(text);
    const voice=pickVoice();
    if(voice) utt.voice=voice;
    utt.lang=(voice&&voice.lang)?voice.lang:(expert.lang||"es-ES");
    utt.rate=0.95;
    utt.onend=()=>{speaking=false;if(cb)cb();};
    setTimeout(()=>{if(speaking) speaking=false;},5000);
    try{
      if(speechSynthesis.paused) speechSynthesis.resume();
      speechSynthesis.speak(utt);
    }catch(e){speaking=false;}
  }
  let unlocked=false;
  function unlockAudio(){
    if(unlocked) return Promise.resolve();
    return new Promise((resolve)=>{
      try{
        const AudioCtx=window.AudioContext||window.webkitAudioContext;
        const ctx=new AudioCtx();
        const gain=ctx.createGain();gain.gain.value=0.0001;
        const osc=ctx.createOscillator();osc.type="sine";osc.frequency.value=220;
        osc.connect(gain);gain.connect(ctx.destination);
        osc.start();osc.stop(ctx.currentTime+0.05);
        ctx.resume().then(()=>{unlocked=true;resolve();});
      }catch(e){unlocked=true;resolve();}
    });
  }
  function warmupTTS(cb){
    try{
      const u=new SpeechSynthesisUtterance(" ");
      u.volume=0;
      const v=pickVoice();
      if(v) u.voice=v;
      u.lang=(v&&v.lang)?v.lang:(expert.lang||"es-ES");
      u.onend=()=>{if(cb)cb();};
      speechSynthesis.speak(u);
    }catch(e){if(cb)cb();}
  }
  let rec=null;
  function startASR(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR) return;
    try{
      rec=new SR();
      rec.lang="es-CL";
      rec.continuous=true;
      rec.interimResults=false;
      rec.onresult=(ev)=>{
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          if(ev.results[i].isFinal){
            const said=ev.results[i][0].transcript.trim();
            if(speaking){setTimeout(()=>handleUserSpeech(said),350);}
            else{handleUserSpeech(said);}
          }
        }
      };
      rec.onend=()=>{try{rec.start();}catch(e){}};
      rec.start();
    }catch(e){/* ignora errores */ }
  }
  function goTo(id){
    const idx=stepIdxById[id];
    if(typeof idx==="number") cur=idx;
    if(started){
      const step=expert.steps[cur];
      let text=step.say;
      if(step.tip) text+=" Consejo: "+step.tip;
      ensureVoices(()=>speak(text));
    }
  }
  function nextByIntent(intent){
    const s=expert.steps[cur],on=s.on||{};
    const target=on[intent];
    if(target) goTo(target);
    else if(intent==="rep") goTo(s.id);
  }
  function handleUserSpeech(said){
    const t=(said||"").toLowerCase().normalize("NFD").replace(/[\\u0300-\\u036f]/g,"");
    const kw=expert.kw||{ok:["listo"],rep:["repite"],back:["atrás"],help:["ayuda"]};
    const hasAny=(arr)=>arr&&arr.some(k=>t.includes(k));
    let intent=null;
    if(hasAny(kw.ok)) intent="ok";
    else if(hasAny(kw.rep)) intent="rep";
    else if(hasAny(kw.back)) intent="back";
    else if(hasAny(kw.help)) intent="help";
    else if(t.includes("nuevo")) intent="nuevo";
    if(intent) nextByIntent(intent);
  }
  function kickstart(){
    if(started) return;
    started=true;
    unlockAudio().then(()=>{
      warmupTTS(()=>{
        const firstId=expert.steps[0]?expert.steps[0].id:"login";
        goTo(firstId);
        startASR();
      });
    });
  }
  document.addEventListener("pointerdown",kickstart,{once:true});
  document.addEventListener("keydown",kickstart,{once:true});
  document.addEventListener("visibilitychange",()=>{
    if(document.visibilityState==="visible"&&speechSynthesis.paused){
      try{speechSynthesis.resume();}catch(e){}
    }
  });
  window.addEventListener("load",()=>{
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./sw.js");
    }
    const first=expert.steps[0]?expert.steps[0].id:"login";
    if(typeof stepIdxById[first]==="number") cur=stepIdxById[first];
  });
})();
</script>
</body>
</html>
