<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<title>Asistente de Voz – Tarjeta Experta</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<style>html,body{margin:0;height:100%;background:#000;color:#000;}</style>
<body>
<script>
(function(){
  const qs = location.hash.slice(1);
  const params = new URLSearchParams(qs);
  function b64ToUtf8(b64){
    try{
      const bin = atob(b64.replace(/-/g,'+').replace(/_/g,'/'));
      const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
      return new TextDecoder().decode(bytes);
    }catch(e){ return null; }
  }

  // ----- Guion por defecto (si no viene #b64=...) -----
  let expert = null;
  if(params.get('b64')){
    try{ expert = JSON.parse(b64ToUtf8(params.get('b64'))); }catch(e){ expert=null; }
  }
  if(!expert){
    expert = {
      v:1, lang:"es-CL",
      kw:{
        ok:["listo","ok","ya","continuar"],
        rep:["repite","repetir","otra vez","no entendi","no entendí"],
        back:["atrás","volver"],
        help:["ayuda","no se","no sé"]
      },
      steps:[
        { id:"bienvenida",
          say:"Hola, seré tu asistente para realizar una transferencia. Si estás listo para comenzar, di: listo.",
          on:{ ok:"login", rep:"bienvenida" } },
        { id:"login",
          say:"Abre la aplicación de tu banco. Cuando estés dentro, di: listo. Te espero el tiempo que necesites.",
          tip:"Si te pide tu clave o huella, introdúcela con calma.",
          on:{ ok:"menu", rep:"login", back:"bienvenida" } },
        { id:"menu",
          say:"Busca Transferencias o Enviar dinero y selecciónala. Cuando lo tengas, di: listo. Tómate tu tiempo.",
          on:{ ok:"origen", rep:"menu", back:"login" } },
        { id:"origen",
          say:"Elige la cuenta desde la que enviarás el dinero. Cuando esté seleccionada, di: listo. Te espero.",
          on:{ ok:"dest", rep:"origen", back:"menu" } },
        { id:"dest",
          say:"¿El destinatario ya está guardado? Si sí, selecciónalo y di: listo. Si es nuevo, di: nuevo.",
          on:{ ok:"monto", nuevo:"dest_new", rep:"dest", back:"origen" } },
        { id:"dest_new",
          say:"Ingresa nombre y RUT, luego banco, tipo y número de cuenta. Al terminar, di: listo. No hay apuro.",
          tip:"Si recibes un código de verificación, cópialo y vuelve.",
          on:{ ok:"monto", rep:"dest_new", back:"dest" } },
        { id:"monto",
          say:"Escribe el monto con cuidado. Cuando esté correcto, di: listo. Te espero.",
          on:{ ok:"rev", rep:"monto", back:"dest" } },
        { id:"rev",
          say:"Revisa destinatario y monto. Si está todo bien, di: listo. Si necesitas corregir, di: atrás.",
          on:{ ok:"auth", back:"monto", rep:"rev" } },
        { id:"auth",
          say:"Autoriza la transferencia con tu token o el código SMS. Cuando confirmes, di: listo. Tómate tu tiempo.",
          on:{ ok:"ok", rep:"auth", back:"rev" } },
        { id:"ok",
          say:"¡Excelente! Transferencia enviada. Si quieres hacer otra, di: repetir. Para terminar, di: listo.",
          on:{ rep:"menu", ok:"end" } },
        { id:"end", say:"Proceso finalizado. Gracias por usar el asistente." }
      ]
    };
  }

  // ----- Estado -----
  let stepIdxById={}; expert.steps.forEach((s,i)=>stepIdxById[s.id]=i);
  let cur=0, started=false, speaking=false, welcomeSpoken=false;
  let reminderTimer=null;

  // ----- TTS -----
  function pickVoice(){
    const v=speechSynthesis.getVoices()||[];
    const prefs=["es-CL","es-419","es-MX","es-ES","es"];
    for(const p of prefs){
      const m=v.find(x=>x.lang&&x.lang.toLowerCase().startsWith(p.toLowerCase()));
      if(m) return m;
    }
    return v[0]||null;
  }
  function ensureVoices(cb){
    const v=speechSynthesis.getVoices();
    if(v&&v.length){ cb(); return; }
    speechSynthesis.onvoiceschanged=()=>cb();
    setTimeout(cb,1000);
  }
  function speak(text, cb){
    if(!started) return;
    try{ speechSynthesis.cancel(); }catch(e){}
    speaking=true;
    const u=new SpeechSynthesisUtterance(text);
    const voice=pickVoice(); if(voice) u.voice=voice;
    u.lang=(voice&&voice.lang)||expert.lang||"es-ES";
    u.rate=0.95;
    u.onend=()=>{ speaking=false; cb&&cb(); };
    setTimeout(()=>{ if(speaking) speaking=false; }, 6000);
    try{
      if(speechSynthesis.paused) speechSynthesis.resume();
      speechSynthesis.speak(u);
    }catch(e){ speaking=false; }
  }

  // ----- Unlock audio + warmup + mic permiso -----
  let unlocked=false;
  function unlockAudio(){
    if(unlocked) return Promise.resolve();
    return new Promise((resolve)=>{
      try{
        const AC=window.AudioContext||window.webkitAudioContext;
        const ctx=new AC();
        const g=ctx.createGain(); g.gain.value=0.0001;
        const o=ctx.createOscillator(); o.frequency.value=220;
        o.connect(g); g.connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime+0.05);
        ctx.resume().then(()=>{unlocked=true; resolve();});
      }catch(e){ unlocked=true; resolve(); }
    });
  }
  function warmupTTS(cb){
    try{
      const u=new SpeechSynthesisUtterance(" ");
      u.volume=0;
      const v=pickVoice(); if(v) u.voice=v;
      u.lang=(v&&v.lang)||expert.lang||"es-ES";
      u.onend=()=>cb&&cb();
      speechSynthesis.speak(u);
    }catch(e){ cb&&cb(); }
  }
  function requestMicOnce(){
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia) return;
    try{
      navigator.mediaDevices.getUserMedia({audio:true})
        .then(s => s.getTracks().forEach(t=>t.stop()))
        .catch(()=>{});
    }catch(e){}
  }

  // ----- ASR (Android/Chrome) -----
  let rec=null;
  function startASR(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR) return;
    try{
      rec=new SR();
      rec.lang="es-CL";
      rec.continuous=true;
      rec.interimResults=false;
      rec.onresult=(ev)=>{
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          if(ev.results[i].isFinal){
            const said=ev.results[i][0].transcript.trim();
            if(speaking) setTimeout(()=>handleUserSpeech(said),350);
            else handleUserSpeech(said);
          }
        }
      };
      rec.onend=()=>{ try{ rec.start(); }catch(e){} };
      rec.start();
    }catch(e){}
  }

  // ----- Recordatorio -----
  function scheduleReminder(){
    if(reminderTimer) clearTimeout(reminderTimer);
    reminderTimer=setTimeout(()=>{
      ensureVoices(()=> speak("Te espero el tiempo que sea necesario para avanzar. Cuando estés listo, di: listo.") );
    }, 20000);
  }

  // ----- Pasos -----
  function goTo(id){
    const i=stepIdxById[id]; if(typeof i!=="number") return;
    cur=i; const s=expert.steps[cur];
    let text=s.say; if(s.tip) text += " Consejo: " + s.tip;
    ensureVoices(()=> speak(text, ()=>{ if(s.id==="bienvenida") welcomeSpoken=true; }));
    if(navigator.vibrate && s.id==="bienvenida") navigator.vibrate([15,60,15]); // feedback sutil
    scheduleReminder();
  }
  function nextByIntent(intent){
    const s=expert.steps[cur], on=s.on||{};
    const target=on[intent];
    if(target) goTo(target);
    else if(intent==="rep") goTo(s.id);
  }
  function handleUserSpeech(said){
    const t=(said||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    const kw=expert.kw||{ ok:["listo"], rep:["repite"], back:["atrás"], help:["ayuda"] };
    const hasAny=(arr)=>arr&&arr.some(k=>t.includes(k));
    if(hasAny(kw.ok)) return nextByIntent("ok");
    if(hasAny(kw.rep)) return nextByIntent("rep");
    if(hasAny(kw.back)) return nextByIntent("back");
    if(hasAny(kw.help)) return nextByIntent("help");
    if(t.includes("nuevo")) return nextByIntent("nuevo");
    if(t.includes("inicio")||t.includes("principio")||t.includes("comenzar")){
      goTo("bienvenida"); return;
    }
  }

  // ----- Arranque con reintentos -----
  function kickstart(){
    if(started) return;
    started=true;
    unlockAudio().then(()=>{ requestMicOnce(); warmupTTS(()=>{
      const first=expert.steps[0]?expert.steps[0].id:"bienvenida";
      goTo(first);
      startASR();
    })});
  }
  function autoStartLoop(){
    let tries=0;
    const tick=()=>{ if(welcomeSpoken || tries>=4) return; tries++; kickstart(); setTimeout(tick, 1200); };
    setTimeout(tick, 250);
  }

  document.addEventListener('pointerdown', kickstart, {once:true});
  document.addEventListener('keydown', kickstart, {once:true});
  window.addEventListener('load', ()=>{
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
    autoStartLoop(); // intenta automáticamente varias veces
  });
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState==="visible" && speechSynthesis.paused){
      try{ speechSynthesis.resume(); }catch(e){}
    }
  });
})();
</script>
</body>
</html>
