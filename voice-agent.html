<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<title>Asistente de Voz – Tarjeta Experta</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<style>
  html, body { margin: 0; height: 100%; background: #000; color: #000; }
</style>
<body>
<script>
(function(){
  // ----- Utilidades para cargar el payload en el fragmento (#b64=...) -----
  const qs = location.hash.slice(1);
  const params = new URLSearchParams(qs);
  function b64ToUtf8(b64){
    try{
      const bin = atob(b64.replace(/-/g,'+').replace(/_/g,'/'));
      const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
      return new TextDecoder().decode(bytes);
    }catch(e){ return null; }
  }

  // ----- Cargar el guion (experto) -----
  let expert = null;
  if(params.get('b64')){
    const txt = b64ToUtf8(params.get('b64'));
    try { expert = JSON.parse(txt); } catch(e){ expert = null; }
  }
  if(!expert){
    // Payload de ejemplo cuando no se recibe un QR con #b64.
    expert = {
      v: 1,
      lang: "es-CL",
      kw: {
        ok: ["listo", "ok", "ya", "continuar"],
        rep: ["repite", "otra vez", "no entendi", "no entendí"],
        back: ["atrás", "volver"],
        help: ["ayuda", "no sé", "no se"]
      },
      steps: [
        {
          id: "bienvenida",
          say: "Hola, seré tu asistente para realizar una transferencia. Si estás listo para comenzar, di: listo.",
          on: { ok: "login", rep: "bienvenida" }
        },
        {
          id: "login",
          say: "Excelente. Ahora abre la aplicación de tu banco en tu teléfono. Cuando estés dentro, di: listo. Te esperaré el tiempo que necesites.",
          tip: "Si te pide tu clave o huella, introdúcela con calma.",
          on: { ok: "menu", rep: "login", back: "bienvenida" }
        },
        {
          id: "menu",
          say: "Busca la opción Transferencias o Enviar dinero en el menú. Cuando la encuentres y la selecciones, di: listo. Tómate todo el tiempo que necesites, estoy aquí.",
          on: { ok: "origen", rep: "menu", back: "login" }
        },
        {
          id: "origen",
          say: "Selecciona la cuenta desde la que enviarás el dinero. Si solo tienes una, estará seleccionada. Cuando lo tengas listo, di: listo. Te espero el tiempo que necesites.",
          on: { ok: "dest", rep: "origen", back: "menu" }
        },
        {
          id: "dest",
          say: "¿El destinatario ya está guardado? Si es así, selecciónalo y di: listo. Si es un nuevo destinatario, di: nuevo. Tómate tu tiempo, te espero.",
          on: { ok: "monto", nuevo: "dest_new", rep: "dest", back: "origen" }
        },
        {
          id: "dest_new",
          say: "Ingresa el nombre y RUT del destinatario, luego selecciona su banco, tipo y número de cuenta. Cuando termines, di: listo. Te espero el tiempo que sea necesario.",
          tip: "Si recibes un código de verificación, cópialo y vuelve.",
          on: { ok: "monto", rep: "dest_new", back: "dest" }
        },
        {
          id: "monto",
          say: "Escribe el monto que deseas transferir con cuidado. Evita ceros de más. Cuando hayas ingresado el monto correctamente, di: listo. Te espero, no hay apuro.",
          on: { ok: "rev", rep: "monto", back: "dest" }
        },
        {
          id: "rev",
          say: "Revisa los datos del destinatario, su RUT, banco, tipo de cuenta y el monto. Si todo está bien, di: listo. Si necesitas corregir algo, di: atrás. Te espero.",
          on: { ok: "auth", back: "monto", rep: "rev" }
        },
        {
          id: "auth",
          say: "Ahora necesitas autorizar la transferencia. Abre tu token o revisa el SMS para obtener el código. Una vez que hayas confirmado la operación, di: listo. Tómate tu tiempo.",
          on: { ok: "ok", rep: "auth", back: "rev" }
        },
        {
          id: "ok",
          say: "¡Excelente! Tu transferencia se ha enviado. Si quieres realizar otra transferencia, di: repetir. Para finalizar, di: listo.",
          on: { rep: "menu", ok: "end" }
        },
        {
          id: "end",
          say: "Proceso finalizado. Gracias por utilizar el asistente."
        }
      ]
    };
  }

  // ----- Índice de pasos y estado global -----
  let stepIdxById = {};
  expert.steps.forEach((s,i) => { stepIdxById[s.id] = i; });
  let cur = 0;
  let started = false;
  let speaking = false;

  // ----- Funciones para síntesis de voz -----
  function pickVoice(){
    const voices = speechSynthesis.getVoices() || [];
    const prefs = ["es-CL","es-419","es-MX","es-ES","es"];
    for(const p of prefs){
      const v = voices.find(vv => vv.lang && vv.lang.toLowerCase().startsWith(p.toLowerCase()));
      if(v) return v;
    }
    return voices[0] || null;
  }
  function ensureVoices(cb){
    const have = speechSynthesis.getVoices();
    if(have && have.length){ cb(); return; }
    speechSynthesis.onvoiceschanged = function(){ cb(); };
    setTimeout(cb, 1000);
  }
  function speak(text, cb){
    if(!started) return;
    try{ speechSynthesis.cancel(); }catch(e){}
    speaking = true;
    const utt = new SpeechSynthesisUtterance(text);
    const voice = pickVoice();
    if(voice) utt.voice = voice;
    utt.lang = (voice && voice.lang) ? voice.lang : (expert.lang || "es-ES");
    utt.rate = 0.95;
    utt.onend = () => { speaking = false; if(cb) cb(); };
    setTimeout(() => { if(speaking) speaking = false; }, 5000);
    try{
      if(speechSynthesis.paused) speechSynthesis.resume();
      speechSynthesis.speak(utt);
    }catch(e){ speaking = false; }
  }

  // ----- Desbloqueo de audio (WebAudio) -----
  let unlocked = false;
  function unlockAudio(){
    if(unlocked) return Promise.resolve();
    return new Promise((resolve) => {
      try{
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioCtx();
        const gain = ctx.createGain();
        gain.gain.value = 0.0001;
        const osc = ctx.createOscillator();
        osc.type = "sine";
        osc.frequency.value = 220;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.05);
        ctx.resume().then(() => { unlocked = true; resolve(); });
      }catch(e){ unlocked = true; resolve(); }
    });
  }
  function warmupTTS(cb){
    try{
      const u = new SpeechSynthesisUtterance(" ");
      u.volume = 0;
      const v = pickVoice();
      if(v) u.voice = v;
      u.lang = (v && v.lang) ? v.lang : (expert.lang || "es-ES");
      u.onend = () => { if(cb) cb(); };
      speechSynthesis.speak(u);
    }catch(e){ if(cb) cb(); }
  }

  // ----- Reconocimiento de voz (solo Android/Chrome) -----
  let rec = null;
  function startASR(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return;
    try{
      rec = new SR();
      rec.lang = "es-CL";
      rec.continuous = true;
      rec.interimResults = false;
      rec.onresult = (ev) => {
        for(let i = ev.resultIndex; i < ev.results.length; i++){
          if(ev.results[i].isFinal){
            const said = ev.results[i][0].transcript.trim();
            if(speaking){ setTimeout(() => handleUserSpeech(said), 350); }
            else { handleUserSpeech(said); }
          }
        }
      };
      rec.onend = () => { try{ rec.start(); }catch(e){} };
      rec.start();
    }catch(e){ /* Ignorar errores */ }
  }

  // ----- Navegación entre pasos -----
  function goTo(id){
    const idx = stepIdxById[id];
    if(typeof idx === 'number'){ cur = idx; }
    if(started){
      const step = expert.steps[cur];
      let text = step.say;
      if(step.tip) text += " Consejo: " + step.tip;
      ensureVoices(() => speak(text));
    }
  }
  function nextByIntent(intent){
    const s = expert.steps[cur];
    const on = s.on || {};
    const target = on[intent];
    if(target) goTo(target);
    else if(intent === 'rep') goTo(s.id);
  }
  function handleUserSpeech(said){
    const t = (said || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const kw = expert.kw || { ok:["listo"], rep:["repite"], back:["atrás"], help:["ayuda"] };
    const hasAny = (arr) => arr && arr.some(k => t.includes(k));
    let intent = null;
    if(hasAny(kw.ok)) intent = 'ok';
    else if(hasAny(kw.rep)) intent = 'rep';
    else if(hasAny(kw.back)) intent = 'back';
    else if(hasAny(kw.help)) intent = 'help';
    else if(t.includes('nuevo')) intent = 'nuevo';
    if(intent) nextByIntent(intent);
  }

  // ----- Gestión del gesto inicial -----
  function kickstart(){
    if(started) return;
    started = true;
    unlockAudio().then(() => {
      warmupTTS(() => {
        const firstId = expert.steps[0] ? expert.steps[0].id : 'login';
        goTo(firstId);
        startASR();
      });
    });
  }
  document.addEventListener('pointerdown', kickstart, { once: true });
  document.addEventListener('keydown', kickstart, { once: true });

  document.addEventListener('visibilitychange', () => {
    if(document.visibilityState === 'visible' && speechSynthesis.paused){
      try{ speechSynthesis.resume(); }catch(e){}
    }
  });

  window.addEventListener('load', () => {
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js');
    }
    const first = expert.steps[0] ? expert.steps[0].id : 'login';
    if(typeof stepIdxById[first] === 'number'){ cur = stepIdxById[first]; }
  });
})();
</script>
</body>
</html>
